<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Hutang — Dashboard</title>

<style>
/* ----------------------
   BASE / LAYOUT
   ---------------------- */
:root{
  --radius:12px;
  --gap:14px;
  --muted-alpha:0.7;
  --transition: .22s ease;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  transition:background var(--transition), color var(--transition);
  padding:20px;
  color:var(--text);
  background:var(--bg);
  min-height:100vh;
}

/* header */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  margin-bottom:16px;
}
.title{
  display:flex;
  align-items:center;
  gap:12px;
}
.logo {
  width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;
  font-weight:700;color:var(--logo-text);background:var(--accent);flex-shrink:0;
  box-shadow:0 6px 18px rgba(0,0,0,0.15);
}
.headline {
  line-height:1;
}
.h1{font-size:18px;margin:0;font-weight:700;color:var(--text)}
.h2{font-size:12px;margin:0;color:var(--muted);font-weight:600}

/* controls */
.controls{display:flex;gap:12px;align-items:center}
.select-wrap{display:inline-flex;align-items:center;gap:8px}
select#themeSelector{
  -webkit-appearance:none;appearance:none;
  padding:8px 12px;border-radius:10px;border:1px solid var(--panel-border);
  background:var(--panel-bg);color:var(--text);font-weight:600;cursor:pointer;
  min-width:170px;
}

/* panel */
.panel{
  background:var(--panel-bg);
  border:1px solid var(--panel-border);
  border-radius:var(--radius);
  padding:14px;
  box-shadow:var(--panel-shadow);
}

/* summary cards */
.summary{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
.card{min-width:150px;padding:12px;border-radius:10px;background:var(--card-bg);border:1px solid var(--panel-border)}
.card h4{margin:0;font-size:12px;color:var(--muted)}
.card p{margin:8px 0 0;font-size:16px;font-weight:700;color:var(--text)}

/* table */
.table-wrap{overflow:auto;border-radius:10px}
table{width:100%;border-collapse:collapse;min-width:820px}
thead th{
  position:sticky;top:0;padding:12px 14px;text-align:left;font-size:13px;
  background:linear-gradient(180deg,var(--accent) 0%, color-mix(in srgb, var(--accent) 85%, transparent) 100%);
  color:var(--header-text);border-bottom:1px solid var(--table-border);
}
tbody td{padding:12px 14px;border-bottom:1px solid var(--row-border);background:var(--row-bg);color:var(--text)}
tbody tr:hover td{background:var(--row-hover)}
.pill{display:inline-block;padding:7px 12px;border-radius:999px;font-weight:700;font-size:12px; white-space:nowrap;}
.pill.lunas{background:color-mix(in srgb, #16a34a 12%, transparent);color:var(--ok);border:1px solid rgba(22,163,74,0.12)}
.pill.belum{background:color-mix(in srgb, #f59e0b 12%, transparent);color:var(--warn);border:1px solid rgba(245,158,11,0.12)}

/* helper */
.empty{text-align:center;padding:30px;color:var(--muted)}

/* responsive */
@media (max-width:900px){thead th{font-size:12px}table{min-width:700px}}

/* THEMES — (SAMA PERSIS PUNYA LU) */
.theme-midnight,
.theme-gelap,
.theme-lautan {
  --bg:#0a1521;
  --text:#e6f0ff;
  --muted:rgba(230,240,255,0.75);
  --accent:#2296ee;
  --panel-bg:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));
  --panel-border:rgba(255,255,255,0.03);
  --panel-shadow:0 8px 28px rgba(2,6,23,0.55);
  --card-bg:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
  --row-bg:transparent;
  --row-hover:rgba(255,255,255,0.02);
  --row-border:rgba(255,255,255,0.03);
  --table-border:rgba(255,255,255,0.04);
  --header-text:#fff;
  --ok:#16a34a;
  --warn:#f59e0b;
  --logo-text:#042225;
}

/* LAUTAN FIX */
.theme-lautan{
  --bg:#0f1720;
  --text:#cfeeff;
  --muted:rgba(160,220,255,0.7);
  --accent:#22d3ee;
  --panel-bg:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.04));
  --logo-text:#04202b;
}

/* TERANG */
.theme-terang{
  --bg:#f6f8fb;
  --text:#0b1220;
  --muted:#5b6b75;
  --accent:#1a73e8;
  --panel-bg:#ffffff;
  --panel-border:#e6eef9;
  --panel-shadow:0 6px 18px rgba(19,38,77,0.06);
  --card-bg:#fff;
  --row-bg:#fff;
  --row-hover:#f4f8ff;
  --row-border:#eef3fb;
  --table-border:#e6eef9;
  --header-text:#fff;
  --ok:#057a31;
  --warn:#b45309;
  --logo-text:#ffffff;
}

/* (Tema lain ga gua ubah apapun) */

select option {
  background:#fff !important;
  color:#000 !important;
}

.hidden{display:none}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="title">
    <div class="logo" id="logo">UT</div>
    <div class="headline">
      <div class="h1">Hutang — Dashboard</div>
    </div>
  </div>

  <div class="controls">
    <div style="text-align:right">
      <div style="font-size:12px;color:var(--muted);font-weight:700;margin-bottom:6px">Pilih Tema:</div>
      <div class="select-wrap">
        <select id="themeSelector">
          <option value="terang">Terang</option>
          <option value="gelap">Gelap</option>
          <option value="lautan">Lautan</option>
          <option value="midnight">Midnight</option>
          <option value="hutan">Hutan</option>
          <option value="pantai">Pantai</option>
          <option value="sunset">Sunset</option>
          <option value="sepia">Sepia</option>
          <option value="retro">Retro</option>
          <option value="permen">Permen</option>
          <option value="darah">Darah</option>
        </select>
      </div>
    </div>
  </div>
</div>

<!-- PANEL -->
<div class="panel">
  <div class="summary" id="summaryRow">
    <div class="card">
      <h4>Total Hutang</h4>
      <p id="totalHutang">Rp 0</p>
    </div>
    <div class="card">
      <h4>Total Piutang</h4>
      <p id="totalPiutang">Rp 0</p>
    </div>
    <div class="card">
      <h4>Belum Lunas</h4>
      <p id="countBelum">0</p>
    </div>
    <div class="card">
      <h4>Lunas</h4>
      <p id="countLunas">0</p>
    </div>
  </div>

  <div class="table-wrap">
    <table id="dataTable">
      <thead>
        <tr>
          <th>Nama</th>
          <th>Type</th>
          <th style="text-align:right">Nominal</th>
          <th>Tanggal</th>
          <th>Keterangan</th>
          <th style="text-align:right">Sisa Hutang</th>
          <th style="width:120px">Status</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td class="empty" colspan="7">Memuat data...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
/* =======================
      THEME SYSTEM
=======================*/
const themeSelector = document.getElementById("themeSelector");

function applyTheme(name){
  document.body.className = "";
  document.body.classList.add(`theme-${name}`);

  const logo = document.getElementById("logo");
  const accent = getComputedStyle(document.body).getPropertyValue("--accent");
  const logoText = getComputedStyle(document.body).getPropertyValue("--logo-text");
  logo.style.background = accent.trim();
  logo.style.color = logoText.trim();
}

themeSelector.addEventListener("change", e=>{
  const v = e.target.value;
  localStorage.setItem("hutang_theme", v);
  applyTheme(v);
});

(function initTheme(){
  const saved = localStorage.getItem("hutang_theme") || "terang";
  themeSelector.value = saved;
  applyTheme(saved);
})();

/* =======================
      CSV FETCH
=======================*/
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQjeiMuhEDZSi97kWRld8LvBgFeq4MiHHKmm1areOT_8uVHlkK5G2L3wFDkcGTm7YG5_aNoY2PTh2jI/pub?output=csv";

const tbody = document.getElementById("tbody");
const totalHutangEl = document.getElementById("totalHutang");
const totalPiutangEl = document.getElementById("totalPiutang");
const countBelumEl = document.getElementById("countBelum");
const countLunasEl = document.getElementById("countLunas");

/* parse CSV naive (ok for your sheet). returns array of rows (arrays) */
function parseCSV(text){
  return text.trim().split("\n").map(r => r.split(","));
}

/* normalize numeric strings: remove thousand separators (.) and spaces, convert comma->dot if needed */
function toNumberFromSheet(val){
  if (val === null || val === undefined) return 0;
  let s = String(val).trim();
  if (s === "") return 0;
  // remove non-digit except minus and comma/dot
  // first remove spaces
  s = s.replace(/\s/g, "");
  // if format like "700.000" (thousand separator) -> remove dots
  // if format like "1,234" (decimal comma) -> convert comma to dot
  // strategy: if contains '.' and length of last segment 3 -> assume thousand separators -> remove dots
  if (s.indexOf(".") !== -1) {
    const parts = s.split(".");
    const last = parts[parts.length - 1];
    if (last.length === 3) {
      s = parts.join(""); // remove dots
    } else {
      // maybe decimal dot, leave it
      s = s;
    }
  }
  // convert comma decimal to dot
  if (s.indexOf(",") !== -1 && s.indexOf(".") === -1) {
    s = s.replace(",", ".");
  } else {
    // remove remaining commas used as thousand sep
    s = s.replace(/,/g, "");
  }
  const n = Number(s);
  return isNaN(n) ? 0 : n;
}

function fmtNum(n){
  const x = Number(n||0);
  return x.toLocaleString("id-ID");
}
function fmtCur(n){ return "Rp " + fmtNum(n); }
function fmtDate(d){
  if(!d) return "-";
  const t = new Date(d);
  if(t.toString()==="Invalid Date") return d;
  return t.toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"});
}

function renderEmpty(msg){
  tbody.innerHTML = `<tr><td class="empty" colspan="7">${msg}</td></tr>`;
}

function loadAndRender(){
  renderEmpty('Memuat data dari Google Sheet...');

  fetch(CSV_URL)
    .then(r=>r.text())
    .then(csv=>{
      const rows = parseCSV(csv);
      // assume header first row
      rows.shift();

      if(!rows.length){
        renderEmpty('Tidak ada data.');
        return;
      }

      tbody.innerHTML = "";
      let totalHutang=0, totalPiutang=0, countBelum=0, countLunas=0;

      rows.forEach(raw => {
        // destructure defensively (some rows may have fewer columns)
        const [id='', nama='', tipe='', nominalRaw='', tanggal='', catatan='', sisaRaw='', statusRaw=''] = raw.concat(Array(8 - raw.length).fill(''));

        // normalize numbers
        const nominal = toNumberFromSheet(nominalRaw);
        const sisa = toNumberFromSheet(sisaRaw);

        // STATUS detection: check 'belum' first, then 'lunas'
        const sLow = (String(statusRaw || "")).toLowerCase();
        let status = (statusRaw || "").trim();
        let isLunas = false;
        let isBelum = false;
        if (sLow.indexOf("belum") !== -1) {
          status = "Belum Lunas";
          isBelum = true;
        } else if (sLow.indexOf("lunas") !== -1) {
          status = "Lunas";
          isLunas = true;
        } else {
          // unknown -> treat as Belum Lunas (safe)
          status = status || "Belum Lunas";
          isBelum = !isLunas;
        }

        // sums
        if ((String(tipe || "").toLowerCase()).includes("hutang")) totalHutang += nominal;
        if ((String(tipe || "").toLowerCase()).includes("piutang")) totalPiutang += nominal;
        if (isLunas) countLunas++; else countBelum++;

        const pillClass = isLunas ? "lunas" : "belum";

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${escapeHtml(nama)}</td>
          <td style="min-width:100px">${escapeHtml(tipe)}</td>
          <td style="text-align:right">${fmtCur(nominal)}</td>
          <td>${fmtDate(tanggal)}</td>
          <td>${escapeHtml(catatan)}</td>
          <td style="text-align:right">${fmtCur(sisa)}</td>
          <td><span class="pill ${pillClass}">${escapeHtml(status)}</span></td>
        `;
        tbody.appendChild(tr);
      });

      // update summary
      totalHutangEl.textContent = fmtCur(totalHutang);
      totalPiutangEl.textContent = fmtCur(totalPiutang);
      countBelumEl.textContent = countBelum;
      countLunasEl.textContent = countLunas;
    })
    .catch(err=>{
      console.error(err);
      renderEmpty('Gagal mengambil data — pastikan Sheet sudah dipublish.');
    });
}

loadAndRender();
setInterval(loadAndRender, 90000);

/* small helper to escape HTML */
function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m])); }
</script>

</body>
</html>
